<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <h2 class="mb-4">Waiting for facial sign in...</h2>
        <p class="lead">Please authenticate on your device.</p>
        <div id="subscribe-status" class="mt-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Initializing secure connection...</p>
        </div>
        <a href="/users/sign_in" class="btn btn-outline-primary mt-4">Back to Login</a>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  // ðŸ”’ SECURITY: Secure token delivery via CSRF-protected API (Axiam v2.0)
  
  try {
    // Step 1: Initialize AxiamActionCableClient if needed
    if (typeof window.initAxiamClientIfNeeded === 'function') {
      await window.initAxiamClientIfNeeded();
    }
    
    if (!window.App || !window.App.axiamClient) {
      throw new Error('AxiamActionCableClient initialization failed. Please refresh the page.');
    }
    
    // Step 2: Fetch verification token securely via API
    const tokenData = await fetchVerificationToken();
    
    if (!tokenData.success) {
      showStatus(tokenData.error || 'Failed to get verification token', 'danger', true);
      return;
    }
    
    // Step 3: Subscribe to facial sign-on channel
    showStatus('Waiting for facial sign in...', 'info');
    
    window.App.axiamClient.subscribeFacialSignOn(tokenData.token, {
      onConnected: () => {
        showStatus('Connected. Waiting for sign in...', 'info');
      },
      
      onDisconnected: () => {
        showStatus('Connection lost. Reconnecting...', 'warning');
      },
      
      onMessage: (data) => {
        handleLoginMessage(data);
      }
    });
    
  } catch (error) {
    showStatus('Error: ' + error.message, 'danger', true);
  }
});

// Fetch verification token via CSRF-protected API
async function fetchVerificationToken() {
  try {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    if (!csrfToken) {
      return { success: false, error: 'CSRF token not found. Please refresh the page.' };
    }
    
    const response = await fetch('/facial_sign_on/get_verification_token', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin'
    });
    
    const data = await response.json();
    
    if (!response.ok || !data.success) {
      return { 
        success: false, 
        error: data.error || 'Session expired. Please try again.' 
      };
    }
    
    return { success: true, token: data.token };
    
  } catch (error) {
    return { 
      success: false, 
      error: 'Network error. Please check your connection.' 
    };
  }
}

// Handle login messages from Axiam
async function handleLoginMessage(data) {
  // Handle successful verification from Axiam
  if (data.status === 'verified' && data.client_id) {
    showStatus('Face verified! Logging in...', 'success');
    
    // Call backend to verify and login user
    try {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      
      const response = await fetch('<%= verified_login_facial_sign_on_index_path %>', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({
          axiam_uid: data.client_id,
          verification_data: data
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        showStatus('Login successful! Redirecting...', 'success');
        setTimeout(() => {
          window.location.href = '<%= root_path %>';
        }, 1000);
      } else {
        showStatus('Login failed: ' + (result.error || 'User not found'), 'danger', true);
      }
      
    } catch (error) {
      showStatus('Error during login: ' + error.message, 'danger', true);
    }
    
  } else if (data.status === 'error' || data.error) {
    const errorMessage = data.message || data.error || 'Authentication failed';
    showStatus(errorMessage, 'danger', true);
    
  } else if (data.status === 'pending' || data.status === 'processing') {
    const message = data.message || 'Processing authentication...';
    showStatus(message, 'info');
  }
}

// Helper function to show status messages
function showStatus(message, type, showRetry = false) {
  const statusDiv = document.getElementById('subscribe-status');
  if (!statusDiv) return;
  
  const alertClass = 'alert-' + type;
  const retryLink = showRetry 
    ? '<br><a href="/facial_sign_on/login" class="alert-link">Try again</a>' 
    : '';
  
  statusDiv.innerHTML = `
    <div class="alert ${alertClass}" role="alert">
      ${message}
      ${retryLink}
    </div>
  `;
}
</script>
