<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <%= render 'layouts/flash' %>
        <h2 class="mb-4">Enable Sign in with Face</h2>

        <% if @qrcode && @qrcode['data'] && @qrcode['data']['qrcode_base64'] %>
          <div class="mb-3">
            <img src="data:image/png;base64,<%= @qrcode['data']['qrcode_base64'] %>" alt="Axiam QRCode" class="img-fluid" style="max-width:200px;">
          </div>
        <% end %>

        <p class="mb-3">Use the QR code scanner in the lower-right corner of the Axiam Authenticator app to scan the QR code above.</p>

        <div id="upload-avatar-step" style="display:none; margin-top:20px;">
          <p class="mb-2">Step 2: Upload your face photo</p>
          <div class="d-flex justify-content-center">
            <%= form_for(current_user, url: registration_path(resource_name), html: { method: :put, multipart: true, class: "w-100" }) do |f| %>
              <%= hidden_field_tag :return_to, enable_facial_sign_on_path %>
              <div class="row g-2 align-items-center justify-content-center">
                <div class="col-auto">
                  <%= f.file_field :avatar, required: true, class: "form-control" %>
                  <%= f.hidden_field :email, value: current_user.email %>
                </div>
                <div class="col-auto">
                  <%= f.submit "Upload Face Photo", class: "btn btn-primary" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <div class="d-flex justify-content-center gap-2 mt-4">
          <a href="/dashboard" class="btn btn-outline-primary">Back to Dashboard</a>
        </div>

        <!-- WebSocket Status -->
        <div class="mt-3">
          <small class="text-muted">
            Connection Status: <span id="websocket-status" class="badge bg-secondary">Connecting...</span>
          </small>
        </div>

        <!-- Include SweetAlert2 for notifications -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
        document.addEventListener('DOMContentLoaded', async function() {
          // Get current user's client_id (axiam_uid)
          const clientId = '<%= current_user.axiam_uid %>';
          
          if (!clientId || clientId === '') {
            updateConnectionStatus(false);
            return;
          }
          
          try {
            // Step 1: Initialize App.cable to connect to Axiam WebSocket server
            // ✨ NEW: JWT Token Management
            let cachedJWTToken = null;
            let tokenExpiresAt = null;
            
            async function getAxiamJWT() {
              const now = Date.now();
              
              if (cachedJWTToken && tokenExpiresAt && now < tokenExpiresAt - 5 * 60 * 1000) {
                return cachedJWTToken;
              }
              
              try {
                const response = await fetch('/auth/axiam-token', {
                  method: 'GET',
                  headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {

                }
                
                const data = await response.json();
                
                if (data.success && data.token) {
                  cachedJWTToken = data.token;
                  tokenExpiresAt = now + (data.expires_in * 1000);
                  return cachedJWTToken;
                }
                
                return null;
              } catch (error) {

                return null;
              }
            }
            
            if (typeof window.App === 'undefined') {
              window.App = {};
            }
            
            if (!App.cable) {
              // ✨ NEW: Get JWT token for authentication
              const jwtToken = await getAxiamJWT();
              
              if (!jwtToken) {
                console.error('Failed to get JWT token for ActionCable');
                updateConnectionStatus(false);
                return;
              }
              
              // Determine Axiam WebSocket URL based on environment
              let axiamWebSocketUrl;
              const hostname = window.location.hostname;
              
              if (hostname === 'localhost' || hostname === '127.0.0.1') {
                axiomWebSocketUrl = 'ws://localhost:3000/cable';  // Development
              } else if (hostname === 'webclientstaging.axiam.io') {
                axiamWebSocketUrl = 'wss://staging.axiam.io/cable';  // Staging
              } else if (hostname === 'webclient.axiam.io' || hostname === 'teranet.axiam.io') {
                axiamWebSocketUrl = 'wss://axiam.io/cable';  // Production
              } else {
                axiamWebSocketUrl = 'wss://staging.axiam.io/cable';  // Default to staging
              }
              
              // Create ActionCable consumer with JWT authentication
              const authenticatedUrl = `${axiamWebSocketUrl}?token=${encodeURIComponent(jwtToken)}`;
              App.cable = ActionCable.createConsumer(authenticatedUrl);
            }
            
            // Step 2: Subscribe to FacialSignOnDeviceChannel BEFORE displaying QR
            const subscription = App.cable.subscriptions.create(
              {
                channel: "FacialSignOnDeviceChannel",
                client_id: clientId
              },
              {
                connected() {
                  updateConnectionStatus(true);
                },
                
                disconnected() {
                  updateConnectionStatus(false);
                },
                
                received(data) {
                  handleSetupEvent(data);
                },
                
                rejected() {
                  updateConnectionStatus(false);
                }
              }
            );
            
          } catch (error) {
            updateConnectionStatus(false);
          }
          
          // Handle setup events
          function handleSetupEvent(data) {
            switch (data.status) {
              case 'registered':
                onDeviceRegistered(data);
                break;
                
              case 'uploaded':
                onFacialUploaded(data);
                break;
            }
          }
          
          function onDeviceRegistered(data) {
            // Show notification
            Swal.fire({
              icon: 'success',
              title: 'Device Registered!',
              text: 'Your device has been registered. You can now upload your facial image.',
              timer: 3000,
              showConfirmButton: false
            });
            
            // Auto-enable Step 2
            document.getElementById('upload-avatar-step').style.display = 'block';
            const finishBtn = document.getElementById('finish-qrcode-btn');
            if (finishBtn) {
              finishBtn.style.display = 'none';
            }
          }
          
          function onFacialUploaded(data) {
            // Show success notification with action buttons
            Swal.fire({
              icon: 'success',
              title: 'Setup Complete!',
              html: '<div style="text-align: left;"><p>"Sign in with Face" has been successfully enabled for your ' + window.location.hostname + ' account.</p><p class="text-muted">You can now sign in using your face—no password or MFA needed!</p></div>',
              showCancelButton: true,
              confirmButtonText: '<i class="fas fa-tachometer-alt"></i> Go to Dashboard',
              confirmButtonColor: '#0d6efd',
              cancelButtonText: '<i class="fas fa-sign-out-alt"></i> Logout',
              cancelButtonColor: '#6c757d',
              allowOutsideClick: false,
              reverseButtons: true
            }).then((result) => {
              if (result.isConfirmed) {
                // User clicked "Go to Dashboard"
                window.location.href = '/dashboard?facial_signin_enabled=true';
              } else if (result.dismiss === Swal.DismissReason.cancel) {
                // User clicked "Logout" - Submit logout form with DELETE method
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '<%= destroy_user_session_path %>';
                
                // Add CSRF token
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                if (csrfToken) {
                  const csrfInput = document.createElement('input');
                  csrfInput.type = 'hidden';
                  csrfInput.name = 'authenticity_token';
                  csrfInput.value = csrfToken;
                  form.appendChild(csrfInput);
                }
                
                // Add _method=delete for Rails
                const methodInput = document.createElement('input');
                methodInput.type = 'hidden';
                methodInput.name = '_method';
                methodInput.value = 'delete';
                form.appendChild(methodInput);
                
                document.body.appendChild(form);
                form.submit();
              }
            });
          }
          
          function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('websocket-status');
            if (statusElement) {
              statusElement.className = connected ? 'badge bg-success' : 'badge bg-warning';
              statusElement.textContent = connected ? 'Connected' : 'Disconnected';
            }
          }
        });
        </script>
      </div>
    </div>
  </div>
</div>
